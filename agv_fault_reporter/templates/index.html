<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AGV 故障上报系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>AGV 故障上报</h1>

    <!-- Tab 容器 -->
    <div class="tab-container">
        <!-- Tab 导航按钮 隐藏-->
        <div class="tab-nav" style="display: none;">
            <!-- 关键修改1：使用Jinja2动态添加 active 类 -->
            <button class="tab-button {% if active_tab == 'detailed' %}active{% endif %}" onclick="switchTab(event, 'detailed')">详细上报</button>
            <button class="tab-button {% if active_tab == 'quick' %}active{% endif %}" onclick="switchTab(event, 'quick')">快速解析</button>
        </div>
        <!-- Tab 内容面板 -->
        <!-- 1. 详细上报面板 -->
        <!-- 关键修改2：同样使用Jinja2动态添加 active 类 -->
        <div id="detailed" class="tab-content {% if active_tab == 'detailed' %}active{% endif %}">
            <form action="/" method="post">
                <label>发现人员: <input type="text" name="reporter_name" required></label>
                <label>故障时间: <input type="datetime-local" name="fault_time" required></label>
                <label>车辆信息: <input type="text" name="vehicle_id" required></label>
                <label>错误类别:
                    <select name="category" required>
                        <option value="">请选择类别...</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>报警描述: <textarea name="description" rows="4" required></textarea></label>
                <label>解决办法: <textarea name="solution" rows="4"></textarea></label>
                <label>责任人: <input type="text" name="responsible_person" required></label>
                <button type="submit">提交</button>
            </form>
        </div>

        <!--
            发现人员：席佳伟
            时间：2025年10月30日16:39
            车辆信息:15号车
            报警描述：5号车送后盖上料，举升后一直报避障，不走车
            解决办法：无
            责任人： @梁海聪
        -->
        <!-- 2. 快速解析面板 -->
        <div id="quick" class="tab-content {% if active_tab == 'quick' %}active{% endif %}">
            <form action="{{ url_for('parse_fault') }}" method="post">
                <label>请在此处粘贴完整的故障信息:</label>
                <textarea name="raw_text" rows="10" required placeholder="例如：&#10;发现人员：曾海彬&#10;时间：2025年10月29日15:53&#10;车辆信息：6号车&#10;报警描述：5号车送后盖上料，举升后一直报避障，不走车&#10;解决办法：无&#10;责任人： @梁海聪"></textarea>
                <button type="submit">解析并提交</button>
            </form>
        </div>
    </div>

    <hr>
    <div class="nav-links">
        <a href="{{ url_for('statistics') }}">查看统计报告</a>
    </div>

    <!-- 关键修改1：添加搜索/筛选表单 -->
    <div class="search-form">
        <h2>故障记录查询</h2>
        <form action="{{ url_for('index') }}" method="get" id="search-form">
            <div class="form-flex-container">
                <!-- 关键修改2：确保所有输入框的 value 都从 search_params 读取 -->
                <input type="text" name="search_reporter" placeholder="发现人员..." value="{{ search_params.search_reporter or '' }}">
                <input type="text" name="search_responsible" placeholder="责任人..." value="{{ search_params.search_responsible or '' }}">
                <input type="text" name="search_vehicle" placeholder="车辆编号..." value="{{ search_params.search_vehicle or '' }}">
                <select name="search_status">
                    <option value="">所有状态</option>
                    {% for status in statuses %}
                    <option value="{{ status }}" {% if status == search_params.search_status %}selected{% endif %}>{{ status }}</option>
                    {% endfor %}
                </select>
                <div class="date-range-group">
                    <input type="date" name="search_start_date" value="{{ search_params.search_start_date or '' }}" title="开始日期">
                    <span class="date-separator">-</span>
                    <input type="date" name="search_end_date" value="{{ search_params.search_end_date or '' }}" title="结束日期">
                </div>
            </div>

            <div class="form-actions">
                <button type="submit">搜索</button>
                <a href="{{ url_for('index') }}" class="button-clear">清空条件</a>
            
                <!-- 将 per_page 选择器移到这里 -->
                <div class="per-page-selector">
                    <label for="per_page_select">每页显示:</label>
                    <select id="per_page_select" name="per_page" onchange="this.form.submit();">
                        {% for count in allowed_per_page %}
                            <option value="{{ count }}" {% if count == per_page %}selected{% endif %}>
                                {{ count }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    <!-- 表格部分无变化 -->
    <table>
        <thead>
            <tr>
                <th>序号</th>
                <th>解决状态</th>
                <th>故障时间</th>
                <th>车辆信息</th>
                <th>错误类别</th>
                <th>报警描述</th>
                <th>处理记录</th>
                <th>责任人</th>
                <th>发现人员</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for fault in faults %}
            <tr>
                <!-- 关键修改2：序号计算使用动态 per_page -->
                <td>{{ (page - 1) * per_page + loop.index }}</td>
                <td class="status-{{ fault.status }}">{{ fault.status }}</td>
                <td>{{ fault.fault_time }}</td>
                <td>{{ fault.vehicle_id }}</td>
                <td>{{ fault.category }}</td>
                <td class="preserve-whitespace">{{ fault.description }}</td>
                <td class="preserve-whitespace">{{ fault.resolution_log or '无' }}</td>
                <td>{{ fault.responsible_person }}</td>
                <td>{{ fault.reporter_name }}</td>
                <td><a href="{{ url_for('edit_fault', fault_id=fault.id) }}">编辑</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- 分页链接 -->
    {% if total_pages > 1 %}
    <div class="pagination">
        <!-- 关键修改：直接将所有 request.args 作为基础参数，更健壮 -->
        {% set all_params = request.args.to_dict() %}

        <!-- 上一页 -->
        {% if page > 1 %}
            {% set _ = all_params.update({'page': page - 1}) %}
            <a href="{{ url_for('index', **all_params) }}">&laquo; 上一页</a>
        {% else %}
            <span class="disabled">&laquo; 上一页</span>
        {% endif %}

        <!-- 页码 -->
        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
                <span class="active">{{ p }}</span>
            {% else %}
                {% set _ = all_params.update({'page': p}) %}
                <a href="{{ url_for('index', **all_params) }}">{{ p }}</a>
            {% endif %}
        {% endfor %}

        <!-- 下一页 -->
        {% if page < total_pages %}
            {% set _ = all_params.update({'page': page + 1}) %}
            <a href="{{ url_for('index', **all_params) }}">&laquo; 下一页</a>
        {% else %}
            <span class="disabled">下一页 &raquo;</span>
        {% endif %}
    </div>
    {% endif %}

    <!-- JavaScript 脚本 -->
    <script>
        function switchTab(event, tabName) {
            // 这部分代码只负责点击切换，不再负责初始状态
            let tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
                tabContents[i].style.display = "none"; // 确保旧的隐藏
            }

            let tabButtons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }

            document.getElementById(tabName).classList.add("active");
            document.getElementById(tabName).style.display = "block"; // 确保新的显示
            event.currentTarget.classList.add("active");
        }
    </script>
</body>
</html>
